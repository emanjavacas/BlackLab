<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2016-08-23 
 | Rendered using Apache Maven Fluido Skin 1.4
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20160823" />
    <meta http-equiv="Content-Language" content="en" />
    <title>BlackLab &#x2013; File formats for the forward index and content store</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.4.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.4.min.js"></script>

                          
        
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Nunito:300"/>
          
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                                                                                                <img src="images/logo-blacklab.png"  alt="BlackLab"/>
                </div>
                      </div>
        <div class="pull-right">                  <a href="http://www.inl.nl/" id="bannerRight">
                                                                                                <img src="images/logo-inl.png"  alt="INL"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="http://www.inl.nl/" class="externalLink" title="INL">
        INL</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="BlackLab">
        BlackLab</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">File formats for the forward index and content store</li>
        
                
                    
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2016-08-23</li>
              <li id="projectVersion" class="pull-right">
                    Version: 1.6.0-SNAPSHOT
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">BlackLab</li>
                              
      <li>
  
                          <a href="index.html" title="Introduction">
          <span class="none"></span>
        Introduction</a>
            </li>
                                                                                                                                                                                                                      
      <li>
  
                          <a href="learn.html" title="Learn">
          <span class="icon-chevron-down"></span>
        Learn</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="getting-started.html" title="Getting Started">
          <span class="none"></span>
        Getting Started</a>
            </li>
                    
      <li>
  
                          <a href="corpus-query-language.html" title="Corpus Query Language">
          <span class="none"></span>
        Corpus Query Language</a>
            </li>
                    
      <li>
  
                          <a href="blacklab-server-overview.html" title="BlackLab Server overview">
          <span class="none"></span>
        BlackLab Server overview</a>
            </li>
                    
      <li>
  
                          <a href="blacklab-server-different-languages.html" title="Using BlackLab Server from different languages">
          <span class="none"></span>
        Using BlackLab Server from different languages</a>
            </li>
                    
      <li>
  
                          <a href="indexing-with-blacklab.html" title="Indexing with BlackLab">
          <span class="none"></span>
        Indexing with BlackLab</a>
            </li>
                    
      <li>
  
                          <a href="add-input-format.html" title="Add An Input Format">
          <span class="none"></span>
        Add An Input Format</a>
            </li>
                    
      <li>
  
                          <a href="improve-search-speed.html" title="Improve Search Speed">
          <span class="none"></span>
        Improve Search Speed</a>
            </li>
                    
      <li>
  
                          <a href="apidocs/index.html" title="API reference">
          <span class="none"></span>
        API reference</a>
            </li>
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>File formats</a>
          </li>
              </ul>
        </li>
                
      <li>
  
                          <a href="downloads.html" title="Downloads">
          <span class="none"></span>
        Downloads</a>
            </li>
                
      <li>
  
                          <a href="faq.html" title="FAQ">
          <span class="none"></span>
        FAQ</a>
            </li>
                
      <li>
  
                          <a href="changelog.html" title="Change Log">
          <span class="none"></span>
        Change Log</a>
            </li>
                
      <li>
  
                          <a href="roadmap.html" title="Road Map">
          <span class="none"></span>
        Road Map</a>
            </li>
                
      <li>
  
                          <a href="newsletter.html" title="Newsletter">
          <span class="none"></span>
        Newsletter</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-right"></span>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>File formats for the forward index and content store</h1>
<p>A BlackLab index is just a Lucene index with a few extra components: forward indices and a content store. The forward index is used to produce KWICs (KeyWord In Context hits), to sort or group on hit context, etc. The content store is used to retrieve the original documents. This page documents the file formats used by these components. File layout are described as (nested) lists of primitive types, with a description of what each value represents. </p>
<div class="section">
<h2><a name="Main_BlackLab_index"></a>Main BlackLab index</h2>
<p>As said, this is just a Lucene index with some extras:</p>

<ul>
  
<li><b>version.dat</b> identifies the index as a BlackLab index. It always contains the string &#x201c;blacklab||2&#x201d;. (The &#x201c;2&#x201d; is a version, but is not used right now. It might be used in the future in case of major changes)</li>
  
<li><b>fi_<i>&lt;fieldname&gt;</i>%<i>&lt;property&gt;</i></b> is the forward index for the a specific field and property, for example &#x201c;fi_contents%lemma&#x201d; is the forward index for the lemma property of the contents field. It provides a quick way to determine what lemma occurs at a particular corpus position. See below for the layout of this directory.</li>
  
<li><b>cs_<i>&lt;fieldname&gt;</i></b> is the content store for the field. BlackLab indices typically contain only one field with a content store, typically called &#x201c;contents&#x201d;, so the subdirectory is named &#x201c;cs_contents&#x201d;. See below for the layout of this directory.</li>
</ul></div>
<div class="section">
<h2><a name="Forward_Index_layout"></a>Forward Index layout</h2>
<p>The forward index contains:</p>

<ul>
  
<li>a terms file, which stores all the unique terms that occur in this field property</li>
  
<li>a documents file, which stores number of tokens in each document, and where to find them in the tokens file</li>
  
<li>a tokens file, which stores the term index for each position in each document</li>
  
<li>a version file, which identifies this as a forward index and stores the version</li>
</ul>
<div class="section">
<h3><a name="terms.dat_Terms_file"></a>terms.dat (Terms file)</h3>

<ul>
  
<li>int: number of terms n</li>
  
<li>some number of blocks (containing all n terms in total), each block:
  
<ul>
    
<li>int: number of terms in block, m</li>
    
<li>m x term string byte offset of term in following data block. [0] is always 0.</li>
    
<li>int: size of following data block in bytes, d</li>
    
<li>d bytes: term string data block (you&#x2019;re done reading blocks when you&#x2019;ve read n terms in total)</li>
  </ul></li>
</ul>
<p>(NOTE: the reason for storing terms in blocks is to prevent integer overflow for the offset values. We could&#x2019;ve used longs for offsets as well, but if you have that many terms, this saves a nontrivial amount of space)</p></div>
<div class="section">
<h3><a name="docs.dat_Documents_file"></a>docs.dat (Documents file)</h3>

<ul>
  
<li>int: number of entries n</li>
  
<li>n x long: doc offset (entry number in tokens.dat (x4 to get byte offset) )</li>
  
<li>n x int: doc length (number of tokens)</li>
  
<li>n x byte: doc deleted?</li>
</ul>
<p>NOTE: the forward index id (fiid) is the entry number in this file!</p></div>
<div class="section">
<h3><a name="tokens.dat_Tokens_file"></a>tokens.dat (Tokens file)</h3>

<ul>
  
<li>q x int: term number for all q tokens in the entire corpus</li>
</ul></div>
<div class="section">
<h3><a name="version.dat"></a>version.dat</h3>

<ul>
  
<li>String &#x201c;fi||<i>&lt;version&gt;</i>&#x201d; (version can currently be 3 or 4)</li>
</ul></div>
<div class="section">
<h3><a name="aold_version_v3_of_terms.dat"></a>(old version (v3) of terms.dat)</h3>

<ul>
  
<li>int: number of terms n</li>
  
<li>n x int: term string byte offsets in term string data. [0] is always 0.</li>
  
<li>int: size of term string data in bytes, b</li>
  
<li>int: size of term string data in bytes, b (yes, this occurs twice)</li>
  
<li>b bytes: term string data</li>
</ul></div></div>
<div class="section">
<h2><a name="Content_Store_layout"></a>Content Store layout</h2>
<p>The content store contains:</p>

<ul>
  
<li>a table of contents file, which stores information about the documents and how they are stored</li>
  
<li>a contents file, which stores all the document content in a block-based format</li>
  
<li>a version file, which identifies this as a content store and stores the version</li>
</ul>
<div class="section">
<h3><a name="toc.dat:"></a>toc.dat:</h3>

<ul>
  
<li>int: number of entries</li>
  
<li>n entries, each entry:
  
<ul>
    
<li>int: content store id (cid)</li>
    
<li>int: total length in bytes</li>
    
<li>int: total length in characters</li>
    
<li>boolean: doc deleted?</li>
    
<li>int: number of blocks</li>
    
<li>n x int: indices of blocks containing file contents</li>
    
<li>n x int: corresponding character offset in the file contents for the start of each block (used to determine what blocks to read for certain character offsets)</li>
  </ul></li>
</ul></div>
<div class="section">
<h3><a name="file-contents.dat"></a>file-contents.dat</h3>

<ul>
  
<li>a number of fixed-size (4096 bytes) blocks containing zlib-compressed utf-8  fragments of files. Together with the toc, the original files can be reconstructed.</li>
</ul></div>
<div class="section">
<h3><a name="version.dat"></a>version.dat</h3>

<ul>
  
<li>String &#x201c;<i>&lt;type&gt;</i>||<i>&lt;version&gt;</i>&#x201d; where type can be fixedblock (current), utf8zip (older), utf8 (legacy)  and version is currently always 1.</li>
</ul></div>
<div class="section">
<h3><a name="aold_version_utf8zip_of_toc.dat"></a>(old version (utf8zip) of toc.dat)</h3>

<ul>
  
<li>int: number of entries</li>
  
<li>n entries, each entry:
  
<ul>
    
<li>int: content store id (ciid)</li>
    
<li>int: what CS file doc is stored in</li>
    
<li>int: offset into the CS file of first block</li>
    
<li>int: total length in bytes</li>
    
<li>int: total length in characters</li>
    
<li>boolean: doc deleted?</li>
    
<li>int: size of blocks used (last block may be smaller)</li>
    
<li>int: number of blocks</li>
    
<li>n x int: block offsets in bytes (relative to start offset; first offset is always 0)</li>
  </ul></li>
</ul></div>
<div class="section">
<h3><a name="aold_version_utf8zip_of_file-contents.dat:_multiple_data.dat_files"></a>(old version (utf8zip) of file-contents.dat: multiple data####.dat files)</h3>

<ul>
  
<li>a number of encoded blocks, representing a number of whole documents;  each block is zlib-compressed utf-8. Blocks can have different sizes (they  have a fixed uncompressed character size - the old toc.dat would tell us where  a document was stored and how many bytes were used)</li>
</ul></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2016
                        <a href="http://www.inl.nl">Instituut voor Nederlandse Taal (INT)</a>.
            All rights reserved.      
                    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
