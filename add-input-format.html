<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2016-08-23 
 | Rendered using Apache Maven Fluido Skin 1.4
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20160823" />
    <meta http-equiv="Content-Language" content="en" />
    <title>BlackLab &#x2013; Adding a new input format</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.4.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.4.min.js"></script>

                          
        
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Nunito:300"/>
          
                  </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                                                                                                <img src="images/logo-blacklab.png"  alt="BlackLab"/>
                </div>
                      </div>
        <div class="pull-right">                  <a href="http://www.inl.nl/" id="bannerRight">
                                                                                                <img src="images/logo-inl.png"  alt="INL"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="http://www.inl.nl/" class="externalLink" title="INL">
        INL</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="index.html" title="BlackLab">
        BlackLab</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Adding a new input format</li>
        
                
                    
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2016-08-23</li>
              <li id="projectVersion" class="pull-right">
                    Version: 1.6.0-SNAPSHOT
        </li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">BlackLab</li>
                              
      <li>
  
                          <a href="index.html" title="Introduction">
          <span class="none"></span>
        Introduction</a>
            </li>
                                                                                                                                                                                                                      
      <li>
  
                          <a href="learn.html" title="Learn">
          <span class="icon-chevron-down"></span>
        Learn</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="getting-started.html" title="Getting Started">
          <span class="none"></span>
        Getting Started</a>
            </li>
                    
      <li>
  
                          <a href="corpus-query-language.html" title="Corpus Query Language">
          <span class="none"></span>
        Corpus Query Language</a>
            </li>
                    
      <li>
  
                          <a href="blacklab-server-overview.html" title="BlackLab Server overview">
          <span class="none"></span>
        BlackLab Server overview</a>
            </li>
                    
      <li>
  
                          <a href="blacklab-server-different-languages.html" title="Using BlackLab Server from different languages">
          <span class="none"></span>
        Using BlackLab Server from different languages</a>
            </li>
                    
      <li>
  
                          <a href="indexing-with-blacklab.html" title="Indexing with BlackLab">
          <span class="none"></span>
        Indexing with BlackLab</a>
            </li>
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>Add An Input Format</a>
          </li>
                    
      <li>
  
                          <a href="improve-search-speed.html" title="Improve Search Speed">
          <span class="none"></span>
        Improve Search Speed</a>
            </li>
                    
      <li>
  
                          <a href="apidocs/index.html" title="API reference">
          <span class="none"></span>
        API reference</a>
            </li>
                    
      <li>
  
                          <a href="file-formats.html" title="File formats">
          <span class="none"></span>
        File formats</a>
            </li>
              </ul>
        </li>
                
      <li>
  
                          <a href="downloads.html" title="Downloads">
          <span class="none"></span>
        Downloads</a>
            </li>
                
      <li>
  
                          <a href="faq.html" title="FAQ">
          <span class="none"></span>
        FAQ</a>
            </li>
                
      <li>
  
                          <a href="changelog.html" title="Change Log">
          <span class="none"></span>
        Change Log</a>
            </li>
                
      <li>
  
                          <a href="roadmap.html" title="Road Map">
          <span class="none"></span>
        Road Map</a>
            </li>
                
      <li>
  
                          <a href="newsletter.html" title="Newsletter">
          <span class="none"></span>
        Newsletter</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                                                      
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-right"></span>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Adding a new input format</h1>
<p>This page provides a simple tutorial. For more in-depth information, see <a href="indexing-with-blacklab.html">Indexing with BlackLab</a>.</p>
<p>If you have text in a format that isn&#x2019;t supported by BlackLab yet, you will have to create a DocIndexer class to support the format. You can have a look at the DocIndexer classes supplied with BlackLab (see the nl.inl.blacklab.indexers package), but here we&#x2019;ll build one from the ground up, step by step.</p>
<p>It&#x2019;s important to note that we assume you have an XML format that is tagged per word. That is, in the main content of your documents, every word should have its own XML tag. If your format is not like that, it&#x2019;s still possible to index it using BlackLab, but the process will be a little bit different. Please <a class="externalLink" href="mailto:jan.niestadt@inl.nl">contact us</a> and we&#x2019;d be happy to help.</p>
<p>For this example, we&#x2019;ll build a simple TEI DocIndexer. We&#x2019;ll keep it a little bit simpler than DocIndexerTei that&#x2019;s already included in BlackLab, but all the basic features will be in there.</p>
<p>Let&#x2019;s get started. The easiest way to add support for an indexer is to derive from DocIndexerXmlHandlers. This base class will take care of XML parsing for you and will call any element handlers you set at the appropriate times.</p>
<p>Here&#x2019;s the first version of our TEI indexer:</p>

<div class="source">
<div class="source"><pre class="prettyprint">public class DocIndexerTei extends DocIndexerXmlHandlers {
    public DocIndexerTei(Indexer indexer, String fileName, Reader reader) {
       super(indexer, fileName, reader);
       DocumentElementHandler documentElementHandler = new DocumentElementHandler();
       addHandler(&quot;TEI&quot;, documentElementHandler);
       addHandler(&quot;TEI.2&quot;, documentElementHandler);
    }
}
</pre></div></div>
<p>We create a DocumentElementHandler (an inner class defined in DocIndexerXmlHandlers) and add it as a handler for the &lt;TEI&amp;gt; and &lt;TEI.2&amp;gt; elements. Why two different elements? Because we want to support both TEI P4 (which uses &lt;TEI.2&amp;gt;) and P5 (which uses &lt;TEI&amp;gt;). The handler will get triggered every time one of these elements is found.</p>
<p>Note that, if we want, we can customize the handler. We&#x2019;ll see an example of this later. But for this document element handler, we don&#x2019;t need any customization. The default DocumentElementHandler will make sure BlackLab knows where our documents start and end and get added to the index in the correct way. It will also automatically add any attributes of the element as metadata fields, but the TEI document elements don&#x2019;t have attributes, so that doesn&#x2019;t apply here.</p>
<p>Let&#x2019;s say you TEI files are part of speech tagged and lemmatized, and you want to add these properties to your index as well. To do so, you will need to add these lines at the top of your constructor, just after calling the superclass constructor:</p>

<div class="source">
<div class="source"><pre class="prettyprint">// Add some extra properties
final ComplexFieldProperty propLemma = addProperty(&quot;lemma&quot;);
final ComplexFieldProperty propPartOfSpeech = addProperty(&quot;pos&quot;);
</pre></div></div>
<p>Because we will also be working with the two default properties that every indexer gets, word and punct, we also need to store a reference to those:</p>

<div class="source">
<div class="source"><pre class="prettyprint">// Get handles to the default properties (the main one &amp; punct)
final ComplexFieldProperty propMain = getMainProperty();
final ComplexFieldProperty propPunct = getPropPunct();
</pre></div></div>
<p>The main property (named &#x201c;word&#x201d;) generally contains the word forms of the text. The punct property is used to store the characters between the words: punctuation and whitespace. These two properties together can be used to generate snippets of context when needed.</p>
<p>Before we create the handler for the word tags, let&#x2019;s create another one for the body tag. We only want to index word tags that occur in a body tag, and we will refer back to this handler to see when we&#x2019;re inside a body tag. Place this line at the end of the constructor:</p>

<div class="source">
<div class="source"><pre class="prettyprint">final ElementHandler body = addHandler(&quot;body&quot;, new ElementHandler());
</pre></div></div>
<p>Now it&#x2019;s time to add a handler for word tags:</p>

<div class="source">
<div class="source"><pre class="prettyprint">// Word elements: index as main contents
addHandler(&quot;w&quot;, new WordHandlerBase() {
    @Override
    public void startElement(String uri, String localName, String qName,
         Attributes attributes) {
       if (!body.insideElement())
         return;
       super.startElement(uri, localName, qName, attributes);

       // Determine lemma and part of speech from the attributes
       String lemma = attributes.getValue(&quot;lemma&quot;);
       if (lemma == null)
         lemma = &quot;&quot;;
       propLemma.addValue(lemma);
       String pos = attributes.getValue(&quot;type&quot;);
       if (pos == null)
         pos = &quot;?&quot;;
       propPartOfSpeech.addValue(pos);

       // Add punctuation
       propPunct.addValue(StringUtil.normalizeWhitespace(consumeCharacterContent()));
    }

    @Override
    public void endElement(String uri, String localName, String qName) {
       if (!body.insideElement())
         return;
       super.endElement(uri, localName, qName);
       propMain.addValue(consumeCharacterContent());
    }
});
</pre></div></div>
<p>Here we see an example of customizing a default handler. The default handler is called WordHandlerBase, and it takes care of storing character positions (needed if we want to highlight hits in the original XML) and reporting progress, but nothing else. You are responsible for indexing the different properties (the defaults word and punct, plus the we you added ourselves, lemma and pos). We use an anonymous inner class and override the startElement() and endElement() methods.</p>
<p>At the top of those methods, notice how we use the body handler we added earlier: we check if we&#x2019;re inside a body element, and return if not, even before calling the superclass method. This makes sure any &lt;w/&gt; tags outside &lt;body/&gt; tags are skipped.</p>
<p>The values for lemma and part of speech are taken from the element attributes and added to the properties we created earlier; simple enough. For the main property (&#x201c;word&#x201d;, the actual word forms) and the &#x201c;punct&#x201d; property (punctuation and whitespace between words), we use the consumeCharacterContent() method. All character content in the XML is collected, and calling consumeCharacterContent() returns the context collected since the last call, and clears the buffer again. At the start of each word, we consume the character content and add it to the punct property; at the end of each word, we do the same again and add it to the main property (&#x201c;word&#x201d;).</p>
<p>If we also want to capture sentence tags, so we can search for sentences containing a word for example, we can add this handler:</p>

<div class="source">
<div class="source"><pre class="prettyprint">// Sentence tags: index as tags in the content
addHandler(&quot;s&quot;, new InlineTagHandler() {
    @Override
    public void startElement(String uri, String localName, String qName,
         Attributes attributes) {
       if (body.insideElement())
         super.startElement(uri, localName, qName, attributes);
    }

    @Override
    public void endElement(String uri, String localName, String qName) {
       if (body.insideElement())
         super.endElement(uri, localName, qName);
    }
});
</pre></div></div>
<p>We only customize this handler because we want to make sure we don&#x2019;t capture sentence tags outside body elements.</p>
<p>We&#x2019;re almost done, but there&#x2019;s one subtle thing to take care of. What happens to the bit of punctuation after the last word? The way we have our indexer now, it would never get added to the index. We should customize the body handler a little bit to take care of that:</p>

<div class="source">
<div class="source"><pre class="prettyprint">    final ElementHandler body = addHandler(&quot;body&quot;, new ElementHandler() {
       @Override
       public void startElement(String uri, String localName, String qName,
          Attributes attributes) {
         consumeCharacterContent(); // clear it to capture punctuation and words
       }

       @Override
       public void endElement(String uri, String localName, String qName) {

         // Before ending the document, add the final bit of punctuation.
         propPunct.addValue(StringUtil.normalizeWhitespace(consumeCharacterContent()));

         super.endElement(uri, localName, qName);
       }
    });
});
</pre></div></div>
<p>Note how we&#x2019;ve also overridden the startElement() method in order to clean the character content buffer at the start of the body element. If we didn&#x2019;t do that, we might get some junk at the first position of the punct property.</p>
<p>That&#x2019;s all there is to it, really. Well, we haven&#x2019;t covered capturing metadata, mostly because TEI doesn&#x2019;t have a clear standard for how metadata is represented. But indexing your particular type of metadata is easy. There&#x2019;s a few helper classes: MetadataElementHandler assumes the matched element name is the name of your metadata field and the character content is the value. MetadataAttributesHandler stores all the attributes from the matched element as metadata fields. MetadataNameValueAttributeHandler assumes the matched element has a name attribute and a value attribute (the attribute names can be specified in the constructor) and stores those as metadata fields.</p>
<p>If you need something fancy for metadata, have a look at the DocIndexers in BlackLab and the implementation of the helper classes mentioned above. It&#x2019;s not hard to make a version that will work for you.</p>
<p>That concludes this simple tutorial. If you have a question, <a class="externalLink" href="mailto:jan.niestadt@inl.nl">contact me</a>!</p>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2016
                        <a href="http://www.inl.nl">Instituut voor Nederlandse Taal (INT)</a>.
            All rights reserved.      
                    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
